<h2 id="motivation">Motivation</h2>

<p>The fashion MNIST dataset is a replacement of the MNIST dataset. Like the 10 digits, it has 10 classes.</p>

<table class="wp-block-table">
  <tr>
    <th>
      <strong>Label</strong>
    </th>
    
    <th>
      <strong>Description</strong>
    </th>
  </tr>
  
  <tr>
    <td>
    </td>
    
    <td>
      T-shirt/top
    </td>
  </tr>
  
  <tr>
    <td>
      1
    </td>
    
    <td>
      Trouser
    </td>
  </tr>
  
  <tr>
    <td>
      2
    </td>
    
    <td>
      Pullover
    </td>
  </tr>
  
  <tr>
    <td>
      3
    </td>
    
    <td>
      Dress
    </td>
  </tr>
  
  <tr>
    <td>
      4
    </td>
    
    <td>
      Coat
    </td>
  </tr>
  
  <tr>
    <td>
      5
    </td>
    
    <td>
      Sandal
    </td>
  </tr>
  
  <tr>
    <td>
      6
    </td>
    
    <td>
      Shirt
    </td>
  </tr>
  
  <tr>
    <td>
      7
    </td>
    
    <td>
      Sneaker
    </td>
  </tr>
  
  <tr>
    <td>
      8
    </td>
    
    <td>
      Bag
    </td>
  </tr>
  
  <tr>
    <td>
      9
    </td>
    
    <td>
      Ankle boot
    </td>
  </tr>
</table>

<p>While it comes bundled with many deep learning libraries, I wanted to use it for my own project. One choice would have been to download it from here<a href="https://github.com/zalandoresearch/fashion-mnist">: https://github.com/zalandoresearch/fashion-mnist</a>. Then extract the dataset and finally load it in my program.</p>

<p>As a programmer, I am not a big fan of doing things on my own. Further, this method is not scalable. If I want a different dataset in the future I will have to perform the same steps manually and create another loader for that data. So, I decided to write my own data loader.</p>

<h2 id="directory-structure">Directory Structure</h2>

<p>I created two scripts: data_downloader.py and fashion_mnist.py. The idea is that data_downloader will be common utility for all the loaders to download their respective datasets. fashion_mnist contains specific code to load the data and the web urls to pass to the data_downloader to fetch the data.</p>

<p>The folder structure is as follows:</p>

<p>utils/data_downloader.py<br />
datasets/fashion_mnist.py</p>

<p>The datasets folder is separate to have a single directory for loader scripts of different datasets and keep them separate from the common utilities.</p>

<h2 id="scripts">Scripts</h2>

<p>Both the scripts are given below:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">""" data_downloader.py
Common functions for downloading dataset
"""</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">cache_subdir</span><span class="p">):</span>
    <span class="s">"""Downloads the file from URL is it is not yet in cache
    Arguments
    fname: name of the file
    origin: Remote URL of the file

    Return: Path to downloaded file
    """</span>

    <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">'~'</span><span class="p">),</span> <span class="s">'.datasets'</span><span class="p">)</span> <span class="c1"># create temporary download location
</span>    <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">cache_subdir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">"does not exist"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Downloading data from"</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">stream</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Finished downloading "</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fpath</span>
</code></pre></div></div>

<p>The datasets are downloaded into a directory named .<em>datasets</em> in the home folder of the user. Linux/OSX systems consider files and directories that start with a dot as hidden. Keeping the downloaded datasets folder reduces visible clutter in the home directory. The script also creates another folder inside the .datasets folder with the name of the dataset for storing the downloaded data. I may add file integrity check in the future but this works for now.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">""" fashion_mnist.py
Fashion MNIST dataset loader
"""</span>

<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">..utils.data_downloader</span> <span class="kn">import</span> <span class="n">get_file</span>


<span class="k">def</span> <span class="nf">load_data</span><span class="p">():</span>
    <span class="s">""" Loads the Fashion MNIST dataset
    return: x_train, y_train, x_test, y_test
    """</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">'datasets'</span><span class="p">,</span> <span class="s">'fashion_mnist'</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="s">'http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/'</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s">'train-labels-idx1-ubyte.gz'</span><span class="p">,</span> <span class="s">'train-images-idx3-ubyte.gz'</span><span class="p">,</span>
             <span class="s">'t10k-labels-idx1-ubyte.gz'</span><span class="p">,</span> <span class="s">'t10k-images-idx3-ubyte.gz'</span><span class="p">]</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">base</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cache_subdir</span><span class="o">=</span><span class="n">dirname</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbpath</span><span class="p">:</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">lbpath</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">imgpath</span><span class="p">:</span>
        <span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">imgpath</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
                                <span class="n">offset</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbpath</span><span class="p">:</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">lbpath</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>


    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">imgpath</span><span class="p">:</span>
        <span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">imgpath</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
                               <span class="n">offset</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>

    <span class="n">y_train</span> <span class="o">=</span> <span class="p">[</span><span class="n">vectorize_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_train</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">vectorize_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_test</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span>

<span class="k">def</span> <span class="nf">vectorize_data</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">e</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">e</span>
</code></pre></div></div>

<p>The original data contains each image represented in a 2D array and the corresponding labels as a single digit. I am not flattening the image here as 2D input is convenient when using Convolutional Neural Networks. The label is vectorized because the output layer of any neural network will be of 10 units each representing a single digit. It is easier to vectorize here and convert it to pure labels later if required.</p>

<p>And finally you can import the dataset as:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">fashion_mnist</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</code></pre></div></div>

<p>Thanks for reading 😎</p>
