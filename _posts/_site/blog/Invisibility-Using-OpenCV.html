<p>OpenCV is the go-to library for all your image processing needs. I used it to create my invisibility project.</p>

<p><img src="/img/invisibility-using-open-cv/invisibility.gif" alt="" /></p>

<p>An object is invisible if you can see through it. The problem then becomes how do you show the background instead of the foreground object. A simple idea is to take a photo of the background first and then replace the area the foreground object covers with the corresponding background region. This is the entire algorithm.</p>

<p>We first take a photo of the background. This now serves our replacement image. In this implementation, we will replace a particular colour with the background. This is similar to the green screen in a movie.</p>

<p><img src="/img/invisibility-using-open-cv/green_screen.jpg" alt="" />
<em><strong>The green region in the frame is replaced with some computer-generated background.</strong><br /> By Iman Crosson - Iman Crosson’s Alphacat channel, YouTube videos, “President Obama on Death of Osama bin Laden (SPOOF)” and “President Obama on Death of Osama SPOOF- BEHIND THE SCENES”, CC BY-SA 3.0, <a href="https://commons.wikimedia.org/w/index.php?curid=15297741">Source</a></em></p>

<p>In this project, I have used a blue colour cloth to do the same. Now, when I walk into the frame holding the cloth, the program will replace the pixels of the cloth with pixels from the initial background image. Although any colour can be chosen, it should be noted that anything else you wear should not be of the same colour. <em>One of my friends chose to mask the colour red. He ended up vanishing parts of his face. I’ll let you guess which ones</em>.</p>

<h1 id="implementation">Implementation</h1>

<h2 id="masking">Masking</h2>

<p>Before we start implementing, I’ll explain a bit about masking. Masking is a way to select a region of the frame. It just shows the parts of the frame which are important.</p>

<p>First, we need to convert the colour of the frame from BGR (Blue Green Red, which is the default way OpenCV reads image instead of traditional RGB) to HSV (Hue  Saturation Value).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>
</code></pre></div></div>

<p>This conversion makes it easier to represent the colour range to select.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">low_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">high_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">180</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">])</span>
</code></pre></div></div>

<p>These particular values are based on trial and error such that it represents the required range of blue colour. We then create a mask based on this threshold and the frame.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">low_thresh</span><span class="p">,</span> <span class="n">high_thresh</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/img/invisibility-using-open-cv/mask.png" alt="" /></p>

<p>The white region represents RGB values of 255,255,255 and the black region represents RGB values of 0,0,0.</p>

<p>Then, to show only the blue region, we use the bitwise_and function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filtered</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></div>

<p>What it essentially does is a pixel-wise and operation on the image1 and image2. We pass in the mask to select the region where we want the and operation to take place. The dark region in the mask remains the same. If we pass image1 and image2, we will get a blend of colours resulting from the anding of pixels of each image. For example, if the pixel of image 1 is 100 and the pixel of image 2 is 255 and the mask is 255, we will get a resulting pixel of 100. However, if the values of the pixels were the same and the mask was 0 then the resulting pixel would be 0.</p>

<p>In our case, we want to select just the region of our frame with blue colour. Since the bitwise_and function requires two parameters for the images and the anding between the same image is the same image, we pass both the image 1 and image 2 parameters as our frame. This gives us the masked region of our current frame.</p>

<p><img src="/img/invisibility-using-open-cv/filtered.jpg" alt="" /></p>

<p>You can read the whole code below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>

<span class="n">low_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">high_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">180</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">])</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">low_thresh</span><span class="p">,</span> <span class="n">high_thresh</span><span class="p">)</span>
<span class="n">filtered</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"mask"</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"filtered"</span><span class="p">,</span> <span class="n">filtered</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Frame"</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="invisibility">Invisibility</h2>

<p>Now that we know the building blocks, we can start building our invisibility project.</p>

<p>First, we need to take a photo of the background. To do this we simply open the camera and take an image.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s">"""get background"""</span>
<span class="k">while</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>     <span class="c1"># wait for seconds
</span>    <span class="k">global</span> <span class="n">background</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Background"</span><span class="p">,</span> <span class="n">background</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>In the code above, I am also waiting for 3 seconds. This is just enough time for pressing a key and moving out of the frame.</p>

<p>We now take the foreground image and apply the threshold to it. This gives us a mask of the object we want to remove.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">low_thresh</span><span class="p">,</span> <span class="n">high_thresh</span><span class="p">)</span>
<span class="n">invisible1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">background</span> <span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">)</span>
</code></pre></div></div>

<p>Here, we create the mask from the foreground image but use the background image to replace it. This is opposite to what we had done in the example above where we have used the mask to select the region from the same image.</p>

<p><img src="/img/invisibility-using-open-cv/background.jpg" alt="" /></p>

<p>There is one problem though. The rest of the image has black pixels because of the mask. We need to fill the rest of the image with the foreground. For this, we need an inverse mask. Inverting a mask is very simple. We know that the highest value in the mask is 255. To invert the mask all we need to do is subtract 255 with the value of the pixel in the mask. That means if the value of a pixel is 0 then 255 - 0 will be 255. Similarly, 255 will become 0.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mask_inv</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">mask</span>
</code></pre></div></div>

<p>This subtracts 255 with each value in the mask.</p>

<p>We can then create the foreground as</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">invisible2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_inv</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/img/invisibility-using-open-cv/foreground.jpg" alt="" /></p>

<p>Finally, we add both the background and the foreground to get the final image.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">invisible</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">invisible1</span><span class="p">,</span> <span class="n">invisible2</span><span class="p">)</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Invisibility"</span><span class="p">,</span> <span class="n">invisible</span><span class="p">)</span>
</code></pre></div></div>

<p>That’s the entire logic of the code. We get the result as</p>

<p><img src="/img/invisibility-using-open-cv/final.jpg" alt="" /></p>

<p>You can grab the entire code <a href="https://github.com/ashwinvaidya17/Invisibility-OpenCV">here</a>.</p>

<p>Thanks for reading 😎</p>
